/*
 * Copyright (C) 2015 Christian Friedl <Mag.Christian.Friedl@gmail.com>
 *
 * This file is part of BJO2.
 *
 * BJO2 is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 3 as
 * published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, see <http://www.gnu.org/licenses/>.
 */

function route(request, callback) {
    var module = null;
    var subModule = null;
    var action = null;
    var err = false;
    var query = undefined;

    if ( request.url === '/' ) {
        module = 'index';
        subModule = 'index';
        action = 'index';
    } else if ( request.url.match(/(\.js|\.css)$/) ) {
        module = 'index';
        subModule = 'index';
        action = 'serveFile';
    } else if ( request.url.match(/^(\/([\w\-_]+)){1,3}(\?([\w\-%_&=]+))?$/) ) {
        var parts = request.url.split('?');
        var queryString = null;
        if (parts.length === 2) {
            queryString = parts.pop();
            var qs = require('querystring');
            query = qs.parse(queryString);
        }
        var path = parts[0].split('/');
        module = typeof(path[1]) === 'string' ? path[1] : 'index';
        subModule = typeof(path[2]) === 'string' ? path[2] : 'index';
        action = typeof(path[3]) === 'string' ? path[3] : 'index';
    } else if ( request.url.match(/\.ico$/) ) {
        console.log('will not route ' + request.url, 'no error');
        module = 'error';
        subModule = 'error';
        action = 'error';
    } else {
        err = 'unable to route: \'' + request.url + '\'';
        module = 'error';
        subModule = 'error';
        action = 'error';
    }

    callback(err, module, subModule, action, query);
}

exports.route = route;
