"use strict";

var bjoo = require('BJOObject.js');
var sq = require('server/sql/query.js');
var condition = require('server/sql/condition.js');
var _ = require('underscore');

function Query(serverQuery) {
    this._serverQuery = serverQuery;
    this._params = [];
}

Query.prototype.queryString = function() {
    switch ( this._serverQuery.type() ) {
        case sq.Type.select:
            return this._selectQueryString();
            break;
        case sq.Type.insert:
            return this._insertQueryString();
            break;
        case sq.Type.update:
            return this._updateQueryString();
            break;
        default:
            throw 'no such query type';
            break;
    }
};

Query.prototype._insertQueryString = function() {
    var table = this._serverQuery.tables()[0];
    var sql = 'INSERT INTO ' + table.name() + ' (';
    sql += _.map(table.fields(), function(field) { return field.name(); }).join(', ');
    sql += ') VALUES (';
    sql += _.map(table.fields(), function(field) { this._params.push(field.value()); return '?'; }.bind(this)).join(', ');
    sql += ')';
    return sql;
};

Query.prototype._updateQueryString = function() {
    var table = this._serverQuery.table();
    var sql = 'UPDATE ' + table.name() + ' SET ';
    sql += _.map(table.fields(), function(field) { this._params.push(field.value()); return field.name() + ' = ?'; }.bind(this)).join(', ');

    if ( this._serverQuery.conditions().length > 0 ) {
        sql += ' ' + this._whereClause();
    }

    return sql;
};

Query.prototype._updateQueryString = function() {
    var table = this._serverQuery.table();
    var sql = 'DELETE FROM ' + table.name();
    if ( this._serverQuery.conditions().length > 0 ) {
        sql += ' ' + this._whereClause();
    }

    return sql;
};

Query.prototype._selectQueryString = function() {
    var sql = 'SELECT ';
    var ff = this._serverQuery.fields();
    if ( this._serverQuery.aggregate() !== null ) {
        switch ( this._serverQuery.aggregate() ) {
            case sq.Aggregate.sum:
                var ffMap = _.map(ff, function(f) { return 'SUM(' + f.name() + ')'; });
                sql += ffMap.join(', ') + ' ';
                break;
            case sq.Aggregate.count:
                sql += 'COUNT(*) ';
                break;
            default:
                throw 'no such aggregate: ' + this._serverQuery.aggregate();
        }
    } else {
        var ffMap = _.map(ff, function(f) { return f.name(); });
        sql += ffMap.join(', ');
    }
    sql += ' FROM ';
    sql += _.map(this._serverQuery.tables(), function(t) { return t.name(); }).join(', ');
    sql += ' ';
    sql += this._whereClause(this._serverQuery);
    return sql;
};

Query.prototype._fieldRefOrValue = function(fieldOrValue) {
    if ( typeof(fieldOrValue.className) !== 'undefined' && fieldOrValue.className() === 'sql.Field' ) {
        return fieldOrValue.name();
    } else {
        return "'" + fieldOrValue + "'";
    }
};

Query.prototype._isField = function(fieldOrValue) {
    return ( typeof(fieldOrValue.className) !== 'undefined' && fieldOrValue.className() === 'sql.Field' ); 
};

Query.prototype._whereClause = function() {
    var sql = 'WHERE ';
    sql += _.map(
        this._serverQuery.conditions(), function(c) { 
            var fieldOrValue = c.compareTo();
            var what = null;
            if ( this._isField(fieldOrValue) ) {
                what = fieldOrValue.name();
            } else {
                what = '?';
                this._params.push(fieldOrValue);
            }
            return c.field().name() + ' ' + this._opString(c.op()) + ' ' + what;
        }.bind(this)).join(' AND ');
    return sql;
};

Query.prototype._opString = function(op) {
    switch ( op ) {
        case condition.Op.eq:
            return '=';
        default:
            throw 'TODO implement _opString!!!';
    }
};

Query.prototype.params = function() {
    if ( arguments.length > 0 ) {
        this._params = Array.prototype.slice.call(arguments);
        return this;
    }
    return this._params;
};

function query(serverQuery) { return new Query(serverQuery); }

exports.Query = Query;
exports.query = query;
