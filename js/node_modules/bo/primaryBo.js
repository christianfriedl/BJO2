var _ = require('underscore');
var m_bo_bo = require('bo/bo.js');

function PrimaryBo(/*sql_db*/p_db, /*dao_dao*/p_dao, /*(optional)bo_bo function()*/p_constructor) {
    m_bo_bo.BO.apply(this, Array.prototype.slice.apply(arguments));
    this._className = 'bo.PrimaryBo';
};

PrimaryBo.prototype = new m_bo_bo.BO();
PrimaryBo.prototype.constructor = PrimaryBo;

PrimaryBo.prototype.loadById = function(id, callback, calculateCalcFields) {
    if ( typeof(calculateCalcFields) === 'undefined' ) {
        calculateCalcFields = true;
    }
    var self = this;
    this._dao.loadById(id, function(err, dao) {
        if (err) return callback(err);
        self._fieldsFromDao(dao);
        callback(false, self);
    }.bind(self), calculateCalcFields);
};

PrimaryBo.prototype.save = function(callback) {
    this._dao.fieldValuesFromBo(this);
    return this._dao.save(function(err, dao) {
        if (err) callback(err);
        this._fieldValuesFromDao(dao);
        return callback(false, this);
    }.bind(this));
};

PrimaryBo.prototype.saveField = function(fieldName, value, callback, /*[{ autoSave: [bool true] }]*/options) {
    var opts = _.extend({ autoSave: true }, options);
    this.field(fieldName).validate(value, this);

    this.validate();

    if ( opts.autoSave ) {
        return this.save(callback);
    }
};



function primaryBo(p_db, p_dao, p_constructor) { return new PrimaryBo(p_db, p_dao, p_constructor); }

exports.primaryBo = primaryBo;
exports.PrimaryBo = PrimaryBo;
