/*
 * Copyright (C) 2015 Christian Friedl <Mag.Christian.Friedl@gmail.com>
 *
 * This file is part of BJO2.
 *
 * BJO2 is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License version 3 as
 * published by the Free Software Foundation.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program; if not, see <http://www.gnu.org/licenses/>.
 */

/*
 * A LookupField defines the lookup into one of its own links
 *
 * e.g. invoice.customerId has a fieldLink for customer to customer.id
 * then the lookupField also contains the information to display customer.name
 *
 * note that a lookup field will be populated by populateLookupFields(), and thus might 
 * fetch its contents at loadById() time - so it is most probably not suited for large tables,
 * but mostly for smallish, normalized-enum-type tables
 */

"use strict";

var _ = require('underscore');

var util = require('util.js');
var m_sql_field = require('sql/field.js');
var m_sql_query = require('sql/query.js');

/**
 * @param {Field} targetLabelField the field from which we will fetch the labels to display on the selectbox or whatever
 */
function LookupField(/*String*/name, /*m_sql_field.DataType*/dataType, /*Object*/value, 
        /*String*/label, /*m_sql_field.Field*/targetLabelField) {
    if ( arguments.length > 0 ) {
        /* @DEVELOPMENT { */
            if ( !(util.isString(name)) ) { throw new Error('typecheck failed on name'); }  
            if ( !(util.isString(dataType)) ) { throw new Error('typecheck failed on dataType'); }  
            if ( !(util.isString(label)) ) { throw new Error('typecheck failed on label'); }  
            if ( !(targetLabelField instanceof m_sql_field.Field || targetLabelField === null) ) { throw new Error('typecheck failed on targetLabelField'); }  
            if ( arguments.length !== 5 ) { throw new Error('Illegal argument length'); }
        /* @DEVELOMPENT } */
        m_sql_field.Field.call(this, name, dataType, value, label);
        this._targetLabelField = targetLabelField;
        this._options = {}; // value -> label
    } else {
        m_sql_field.Field.call(this);
    }
}

LookupField.prototype = new m_sql_field.Field();
LookupField.prototype.constructor = LookupField;

LookupField.prototype.clone = function() {
    var f = new LookupField(this._name, this._dataType, this._value, this._label, this._targetLabelField);
    f.table(this._table);
    f.isEditable(this._isEditable);
    f.isRequired(this._isRequired);
    f.links(this._links);
    f._targetLabelField = this._targetLabelField;
    f._options = this._options;
    f._id = this._id; // one exception to the use-the-setter-luke rule
    return f;
};

/**
 * getter/setter
 * options, here are the looked-up values
 */
LookupField.prototype.options = function(/*Array(Object{value->label})*/ options) {
    if ( typeof(options) !== 'undefined' ) {
        this._options = options;
        return this;
    }
    return this._options;
};

LookupField.prototype.addOption = function(/*String*/ label, /*BJOObject*/ value) {
    this._options[value] = label;
};

/**
 * getter for "our" link
 */
/*m_sql_fieldLink.FieldLink*/ LookupField.prototype.tableLink = function() {
    return this.link(this._targetLabelField.table());
};
/**
 * getter, helps the fetching
 */
LookupField.prototype.valueFieldName = function() {
    return this.tableLink().targetField().name();
};

LookupField.prototype.labelFieldName = function() {
    return this._targetLabelField.name();
};

/**
 * getter/setter
 */
/*sql.Field/this*/ LookupField.prototype.targetLabelField = function(/*[sql.Field]*/ targetLabelField) {
    if ( typeof(targetLabelField) !== 'undefined') {
        this._targetLabelField = targetLabelField;
        return this;
    }
    return this._targetLabelField;
}

/*m_sql_query.Query*/LookupField.prototype.query = function() {
    var q = m_sql_query.select()
        .fields([ this.tableLink().targetField(), this._targetLabelField ])
        .from(this._targetLabelField.table())
        .orderBy(m_sql_orderBy.orderBy(this.tableLink.targetField(), m_sql_orderBy.Direction.asc);
    return q;
};

/*Object*/LookupField.prototype.webize = function() {
    return { 
        className: this.constructor.name, 
        name: this._name, 
        dataType: this._dataType, 
        value: this._value, 
        label: this._label,
        seq: this._seq,
        isEditable: this._isEditable,
        isRequired: this._isRequired,
        links: this._linksWebized(),
        options: this._options
    };
};

function lookupField(/*String*/name, /*m_sql_field.DataType*/dataType, /*BJOObject*/value, /*String*/label, /*Field*/targetLabelField) { if ( arguments.length > 0 ) { return new LookupField(name, dataType, value, label, targetLabelField); } else { return new LookupField(); } }

exports.LookupField = LookupField;
exports.lookupField = lookupField;
